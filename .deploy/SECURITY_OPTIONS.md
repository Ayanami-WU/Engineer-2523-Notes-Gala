# 目录浏览安全方案对比

## 背景问题

课程资料中有文件夹（如"真题/"、"历年卷/"），用户点击链接时会遇到：
- ❌ 403 Forbidden 错误（nginx默认禁止目录浏览）

需要在**功能性**和**安全性**之间取得平衡。

---

## 方案对比

### 方案1：受限的目录浏览（当前方案）⭐ 推荐

**配置**：
```nginx
# 默认禁用
autoindex off;

# 仅允许课程文件夹的子目录
location ~ ^/(calculus|linear-algebra|...)/.+/$ {
    autoindex on;
}

# 禁止访问隐藏文件
location ~ /\. {
    deny all;
}
```

**安全措施**：
- ✅ 只允许浏览课程子文件夹（如 `/calculus/真题/`）
- ✅ 禁止浏览根目录、assets 等系统目录
- ✅ 禁止访问 `.git`、`.env` 等隐藏文件
- ✅ 禁止访问备份文件（`~`、`.bak`）
- ✅ 添加安全响应头（防XSS、点击劫持等）

**优点**：
- ✅ 用户体验好：可以浏览文件夹并单独下载文件
- ✅ 安全性足够：限制了浏览范围
- ✅ 无需修改代码：MD文件链接保持不变
- ✅ 自动更新：新增文件自动出现在列表中

**缺点**：
- ⚠️ 目录结构对外可见
- ⚠️ 批量下载风险（爬虫可以下载所有文件）

**适用场景**：
- 课程笔记等公开资料分享
- 没有敏感内容
- 希望用户能灵活下载

---

### 方案2：完全禁用目录浏览 + ZIP打包

**实现**：
1. 将所有文件夹打包成 ZIP（如 `真题.zip`）
2. 修改所有 MD 文件中的链接
3. 更新文件类型图标为 ZIP 图标

**配置**：
```nginx
autoindex off;  # 完全禁用
```

**优点**：
- ✅ 最安全：完全禁用目录浏览
- ✅ 便于整体下载
- ✅ 减少请求次数

**缺点**：
- ❌ 用户无法单独下载某个文件
- ❌ 需要批量修改 MD 文件
- ❌ Git 仓库变大（重复存储原文件+ZIP）
- ❌ 维护成本高（每次更新都要重新打包）

**适用场景**：
- 对安全要求极高
- 用户通常需要下载整个文件夹
- 愿意牺牲灵活性换取安全

---

### 方案3：生成静态索引页面

**实现**：
为每个文件夹创建 `index.html`，手动列出文件清单。

示例结构：
```
真题/
├── index.html  (手动创建的文件列表页)
├── 2021真题.pdf
├── 2022真题.pdf
└── 答案.pdf
```

**配置**：
```nginx
autoindex off;  # 禁用自动索引
index index.html;  # 使用自定义索引页
```

**优点**：
- ✅ 完全可控：只展示想展示的文件
- ✅ 美观：可以自定义样式，添加说明
- ✅ 安全：不暴露完整目录结构
- ✅ 灵活：可以对文件分组、排序

**缺点**：
- ❌ 维护成本高：每次添加文件都要手动更新
- ❌ 工作量大：每个文件夹都要创建索引页

**适用场景**：
- 文件变动不频繁
- 需要对文件进行说明和分类
- 追求美观和专业

---

## 安全性对比

| 方面 | 方案1（受限目录浏览） | 方案2（ZIP打包） | 方案3（静态索引） |
|------|---------------------|-----------------|------------------|
| **信息泄露** | ⚠️ 中等 | ✅ 低 | ✅ 低 |
| **批量下载** | ⚠️ 可能 | ✅ 受控 | ⚠️ 可能 |
| **配置文件暴露** | ✅ 已防护 | ✅ 已防护 | ✅ 已防护 |
| **XSS/点击劫持** | ✅ 已防护 | ✅ 已防护 | ✅ 已防护 |

---

## 风险评估

### 当前风险（方案1）

**已防护的风险**：
- ✅ 配置文件泄露（`.git`、`.env` 等已禁止）
- ✅ 备份文件泄露（`~`、`.bak` 已禁止）
- ✅ 点击劫持、XSS 等常见攻击
- ✅ 系统目录浏览（只允许课程子文件夹）

**剩余风险**：
- ⚠️ 目录结构可见
  - 影响：攻击者可以看到文件组织方式
  - 严重度：低（课程笔记本来就是公开的）

- ⚠️ 批量爬取
  - 影响：机器人可以下载所有资料
  - 严重度：低（内容本身就是共享的）
  - 缓解：可以添加 rate limiting

### 是否需要更严格的安全措施？

**不需要，如果**：
- 网站内容是课程笔记等公开资料
- 没有个人信息、密码等敏感数据
- 不介意被爬虫下载

**需要，如果**：
- 包含敏感或付费内容
- 需要严格的访问控制
- 对流量成本敏感

---

## 建议

### 对于课程笔记网站（当前场景）

**推荐方案1**，原因：
1. MkDocs 构建后只有 HTML/CSS/JS 和资料文件，本来就是公开内容
2. 没有敏感配置（已通过 nginx 规则防护）
3. 用户体验最好
4. 维护成本最低

### 如果未来需要更高安全性

可以考虑：
1. 添加基础认证（HTTP Basic Auth）
2. 使用 rate limiting 防止爬虫
3. 改用方案2或方案3

---

## 额外的安全加固建议

如果需要进一步提升安全性，可以添加：

### 1. Rate Limiting（防止批量下载）
```nginx
limit_req_zone $binary_remote_addr zone=download:10m rate=10r/s;

location ~* \.(pdf|zip|docx)$ {
    limit_req zone=download burst=20;
}
```

### 2. 访问日志监控
```nginx
access_log /var/log/nginx/access.log combined;
```
定期检查异常访问模式

### 3. IP 黑名单（如果发现恶意爬虫）
```nginx
deny 1.2.3.4;
deny 5.6.7.0/24;
```

---

## 总结

当前配置（方案1 + 安全加固）适合课程笔记分享场景，平衡了：
- ✅ 功能性：用户可以方便浏览和下载
- ✅ 安全性：防护了常见攻击和敏感文件泄露
- ✅ 维护性：无需额外维护成本

如果对安全有特殊要求，可以随时切换到方案2或方案3。
