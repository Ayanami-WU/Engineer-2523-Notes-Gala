# GitLab CI/CD Pipeline for MkDocs Material (Docker Deployment)
# 使用 Docker 构建和部署到远程服务器

stages:
  - build
  - deploy

variables:
  # Docker 配置
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"
  # 镜像标签
  IMAGE_NAME: mkdocs-notes
  IMAGE_TAG: $CI_COMMIT_SHORT_SHA
  # 部署配置
  CONTAINER_NAME: mkdocs-notes
  HOST_PORT: 8111
  CONTAINER_PORT: 80

# 构建 Docker 镜像
build_docker:
  stage: build
  image: docker:24-cli
  services:
    - docker:24-dind
  before_script:
    - echo "Building Docker image for commit $CI_COMMIT_SHORT_SHA"
    - docker info
  script:
    # 验证 Dockerfile 存在
    - test -f Dockerfile || (echo "Dockerfile not found!" && exit 1)
    # 构建镜像
    - docker build -t $IMAGE_NAME:$IMAGE_TAG -t $IMAGE_NAME:latest .
    # 保存镜像为 tar 文件
    - docker save $IMAGE_NAME:latest -o mkdocs-image.tar
  artifacts:
    paths:
      - mkdocs-image.tar
      - docker-compose.yml
      - deploy-docker.sh
    expire_in: 1 hour
  only:
    - master
    - main
  tags:
    - docker

# 部署到远程服务器
deploy_to_server:
  stage: deploy
  image: alpine:latest
  before_script:
    # 安装必要工具
    - apk add --no-cache openssh-client rsync bash
    # 设置 SSH
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' > ~/.ssh/id_rsa
    - chmod 600 ~/.ssh/id_rsa
    - ssh-keyscan -H $SERVER_HOST >> ~/.ssh/known_hosts 2>/dev/null
    # 验证 SSH 连接
    - ssh -o StrictHostKeyChecking=no $SERVER_USER@$SERVER_HOST "echo 'SSH connection successful'"
  script:
    - echo "Deploying to $SERVER_USER@$SERVER_HOST:$DEPLOY_PATH"
    # 创建部署目录
    - ssh $SERVER_USER@$SERVER_HOST "mkdir -p $DEPLOY_PATH"
    # 传输文件到服务器
    - rsync -avz --progress mkdocs-image.tar $SERVER_USER@$SERVER_HOST:$DEPLOY_PATH/
    - rsync -avz --progress docker-compose.yml $SERVER_USER@$SERVER_HOST:$DEPLOY_PATH/
    - rsync -avz --progress deploy-docker.sh $SERVER_USER@$SERVER_HOST:$DEPLOY_PATH/
    # 在服务器上执行部署脚本
    - |
      ssh $SERVER_USER@$SERVER_HOST << 'EOF'
        set -e
        cd $DEPLOY_PATH
        echo "Loading Docker image..."
        docker load -i mkdocs-image.tar
        echo "Stopping old container..."
        docker-compose down || true
        echo "Starting new container..."
        docker-compose up -d
        echo "Cleaning up old images..."
        docker image prune -f
        echo "Deployment completed!"
        echo "Service running at: http://$SERVER_HOST:8111"
      EOF
  dependencies:
    - build_docker
  only:
    - master
    - main
  environment:
    name: production
    url: http://$SERVER_HOST:8111
  tags:
    - docker
