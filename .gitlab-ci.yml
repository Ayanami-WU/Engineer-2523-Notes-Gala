# GitLab CI/CD Pipeline for MkDocs Material
# 方案：通过 SSH 触发服务器端构建和部署
# 优势：避免 Runner 资源限制，构建在服务器上进行

stages:
  - deploy

variables:
  # 部署配置
  DEPLOY_DIR: "~/mkdocs-deploy"
  SCRIPT_NAME: "build-and-deploy-server.sh"

# 自动化部署到服务器
deploy_to_server:
  stage: deploy
  image: alpine:latest
  before_script:
    - echo "Preparing to deploy to $SERVER_USER@$SERVER_HOST"
    # 安装 SSH 客户端
    - apk add --no-cache openssh-client bash
    # 设置 SSH 密钥
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' > ~/.ssh/id_rsa
    - chmod 600 ~/.ssh/id_rsa
    # 添加服务器到 known_hosts
    - ssh-keyscan -H $SERVER_HOST >> ~/.ssh/known_hosts 2>/dev/null
    # 验证 SSH 连接
    - echo "Testing SSH connection..."
    - ssh -o StrictHostKeyChecking=no $SERVER_USER@$SERVER_HOST "echo 'SSH connection successful!'"
  script:
    - echo "=========================================="
    - echo "GitLab CI - 服务器端自动化部署"
    - echo "Commit:$CI_COMMIT_SHORT_SHA"
    - echo "Branch:$CI_COMMIT_BRANCH"
    - echo "=========================================="
    - echo ""
    # 在服务器上执行部署
    - |
      ssh -o StrictHostKeyChecking=no $SERVER_USER@$SERVER_HOST bash -s << 'EOF'
      set -e
      DEPLOY_DIR=~/mkdocs-deploy
      SCRIPT_NAME=build-and-deploy-server.sh

      echo "→ 进入部署目录..."
      mkdir -p $DEPLOY_DIR
      cd $DEPLOY_DIR

      echo "→ 检查部署脚本..."
      if [ ! -f "$SCRIPT_NAME" ]; then
        echo "→ 下载部署脚本..."
        wget -q https://git.koala-studio.org.cn/Koala-Inno-WMX/e-2523-note/-/raw/main/build-and-deploy-server.sh -O $SCRIPT_NAME
        chmod +x $SCRIPT_NAME
        echo "✓ 部署脚本已下载"
      else
        echo "✓ 部署脚本已存在"
      fi

      echo ""
      echo "=========================================="
      echo "开始执行服务器端构建和部署..."
      echo "=========================================="
      echo ""

      # 执行部署脚本
      ./$SCRIPT_NAME

      echo ""
      echo "=========================================="
      echo "GitLab CI 部署任务完成！"
      echo "=========================================="
      EOF
    - echo ""
    - echo "✓ 部署成功完成"
    - echo "访问地址:http://$SERVER_HOST:8111"
  only:
    - master
    - main
  environment:
    name: production
    url: http://$SERVER_HOST:8111
  # 如果需要使用专用 Runner，取消下面的注释
  # tags:
  #   - docker
